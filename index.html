<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CONVERTIDOR DE PRONOSTICOS BAHIAS</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --navy: #0a192f; --cyan: #64ffda; --white: #e6f1ff; --card: #112240; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--navy); color: var(--white); padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        h1 { text-align: center; color: var(--cyan); text-transform: uppercase; letter-spacing: 2px; }
        .file-section { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--cyan); text-align: center; }
        .grid-zonas { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; }
        .zona-card { background: var(--card); padding: 15px; border-radius: 10px; border-top: 4px solid var(--cyan); position: relative; }
        textarea { width: 100%; height: 180px; background: #0a192f; border: 1px solid #233554; color: white; border-radius: 5px; padding: 10px; box-sizing: border-box; resize: none; font-size: 0.85rem; }
        .btn-grande { background: var(--cyan); color: var(--navy); border: none; padding: 20px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 1.2rem; cursor: pointer; margin-top: 25px; transition: 0.3s; }
        .btn-grande:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(100, 255, 218, 0.4); }
        .status-badge { background: var(--cyan); color: var(--navy); font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; position: absolute; top: 15px; right: 15px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>CONVERTIDOR DE PRONOSTICOS BAHIAS</h1>
    
    <div class="file-section">
        <label><b>1. EXCEL ORIGINAL:</b></label> <input type="file" id="inputExcel" accept=".xlsx"><br><br>
        <label><b>2. SUBIR TXTs (Penas, QuellonMelinka, etc):</b></label> <input type="file" id="inputTxts" accept=".txt" multiple onchange="cargarArchivos(this)">
    </div>

    <div class="grid-zonas">
        <div class="zona-card"><h3>MAULLÍN</h3><span id="b_maullin72" class="status-badge">OK</span><textarea id="txt_maullin72"></textarea></div>
        <div class="zona-card"><h3>CHACAO</h3><span id="b_chacao72" class="status-badge">OK</span><textarea id="txt_chacao72"></textarea></div>
        <div class="zona-card"><h3>PUERTO MONTT</h3><span id="b_pmontt72" class="status-badge">OK</span><textarea id="txt_pmontt72"></textarea></div>
        <div class="zona-card"><h3>BOCA DEL GUAFO</h3><span id="b_guafo72" class="status-badge">OK</span><textarea id="txt_guafo72"></textarea></div>
        <div class="zona-card"><h3>CHACABUCO</h3><span id="b_chacabuco72" class="status-badge">OK</span><textarea id="txt_chacabuco72"></textarea></div>
        <div class="zona-card"><h3>GOLFO DE PENAS</h3><span id="b_golfopenas72" class="status-badge">OK</span><textarea id="txt_golfopenas72"></textarea></div>
        <div class="zona-card"><h3>MELINKA</h3><span id="b_melinka72" class="status-badge">OK</span><textarea id="txt_melinka72"></textarea></div>
    </div>

    <button class="btn-grande" onclick="procesarTodo()">GENERAR EXCEL CORREGIDO</button>
</div>

<script>
    const meses = ["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];
    const mapaAlias = {
        "penas72": "txt_golfopenas72", "golfopenas72": "txt_golfopenas72",
        "quellonmelinka72": "txt_melinka72", "melinka72": "txt_melinka72",
        "maullin72": "txt_maullin72", "chacao72": "txt_chacao72",
        "pmontt72": "txt_pmontt72", "guafo72": "txt_guafo72", "chacabuco72": "txt_chacabuco72"
    };

    function cargarArchivos(input) {
        Array.from(input.files).forEach(file => {
            const nombre = file.name.toLowerCase().replace(".txt", "");
            const id = mapaAlias[nombre];
            if (id) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById(id).value = e.target.result;
                    document.getElementById(id.replace("txt_", "b_")).style.display = "block";
                };
                reader.readAsText(file);
            }
        });
    }

    function limpiarTexto(t) {
        if (!t) return "";
        let l = t.trim().replace(/,$/, "");
        if (l.endsWith(".") && !/\d$/.test(l.slice(-2, -1))) l = l.slice(0, -1);
        return l.trim().replace(/\s+/g, " ");
    }

    function obtenerNombreDia(numStr) {
        const dias = ["DOMINGO", "LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO"];
        const num = parseInt(numStr);
        const hoy = new Date();
        let f = new Date(hoy.getFullYear(), hoy.getMonth(), num);
        if (num < hoy.getDate() - 10) f = new Date(hoy.getFullYear(), hoy.getMonth() + 1, num);
        return dias[f.getDay()];
    }

    function procesarTodo() {
        const fileInput = document.getElementById("inputExcel");
        if (fileInput.files.length === 0) { alert("Sube el Excel."); return; }

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            const idsHojas = ["maullin72", "chacao72", "pmontt72", "guafo72", "chacabuco72", "golfopenas72", "melinka72"];
            const mesActual = meses[new Date().getMonth()];

            idsHojas.forEach(idHoja => {
                const ws = wb.Sheets[idHoja];
                if (!ws) return;

                // --- LIMPIEZA CORREGIDA (Se agregaron F7, F14, F18, F24) ---
                const celdasALimpiar = [
                    "B2","B3","B4","B5","B7","C7","D7","E7","F7","G7","H7","I7",
                    "B8","B9","B10","B11","B12","C11","C12",
                    "B13","B14","C14","D14","E14","F14","G14","H14","I14",
                    "B16","C16","D16","B17","B18","C18","D18","E18","F18","G18","H18","I18",
                    "B19","B20","B22","C22","D22","B23","B24","C24","D24","E24","F24","G24","H24","I24",
                    "B25","B26"
                ];
                celdasALimpiar.forEach(r => { if(ws[r]) ws[r] = { t: 's', v: "" } });

                const texto = document.getElementById("txt_" + idHoja).value.trim();
                if (!texto) return;

                // 1. CAPTURA INDICE UV (B10)
                const mUV = texto.match(/INDICE DE RADIACION ULTRAVIOLETA:\s*([\s\S]*?)(?=\r?\n|APRECIACION|VALIDO|$)/i);
                if (mUV) ws["B10"] = { t: 's', v: limpiarTexto(mUV[1]) };

                // 2. DIA 1 (Cabecera)
                const mCab = texto.match(/VALIDO DESDE\s*(\d{2})/i);
                if (mCab) {
                    ws["B2"] = { t: 's', v: obtenerNombreDia(mCab[1]) };
                    ws["B3"] = { t: 'n', v: parseInt(mCab[1]) };
                    ws["B4"] = { t: 's', v: mesActual };
                }

                // 3. SITUACION SINOPTICA
                const mSit = texto.match(/SITUACION SINOPTICA:\s*([\s\S]*?)(?=PRONOSTICO)/i);
                if (mSit) ws["B5"] = { t: 's', v: limpiarTexto(mSit[1]) };

                // 4. PRONOSTICO PRINCIPAL
                const mPro = texto.match(/PRONOSTICO:\s*([\s\S]*?)(?=TEMPERATURA|PRONOSTICO VALIDO|EMITIDO|$)/i);
                if (mPro) {
                    const p = mPro[1];
                    ws["B7"] = { t: 's', v: limpiarTexto(p.split(",")[0]) };
                    const v1 = p.match(/VIS\s+([\s\S]+?)(?=VTO|MAR)/i);
                    const v2 = p.match(/VTO\s+([\s\S]+?)(?=MAR|$)/i);
                    const v3 = p.match(/MAR\s+([\s\S]+?)(?=\.[\s\r\n]*$|\r?\n|$)/i);
                    if (v1) ws["C7"] = { t: 's', v: limpiarTexto(v1[1]) };
                    if (v2) ws["E7"] = { t: 's', v: limpiarTexto(v2[1]) };
                    if (v3) ws["I7"] = { t: 's', v: limpiarTexto(v3[1]) };
                }

                // 5. TEMPERATURAS
                const tMin1 = texto.match(/MINIMA\s*PROBABLE\s*[:\-]?\s*(\d+\s*°C)/i);
                const tMax1 = texto.match(/MAXIMA\s*PROBABLE\s*[:\-]?\s*(\d+\s*°C)/i);
                if (tMin1) ws["B8"] = { t: 's', v: tMin1[1] };
                if (tMax1) ws["B9"] = { t: 's', v: tMax1[1] };

                // 6. NOCTURNO
                const mNoc = texto.match(/PRONOSTICO VALIDO DESDE\s*(\d{2})\d{4}\s*HASTA\s*(\d{2})\d{4}[\s\S]*HORA LOCAL\.\s*([\s\S]*?)(?=(?:LUNES|MARTES|MIERCOLES|JUEVES|VIERNES|SABADO|DOMINGO)\s*\d{2}|MET011|EMITIDO|$)/i);
                if (mNoc) {
                    ws["B11"] = { t: 's', v: obtenerNombreDia(mNoc[1]) + " " + mNoc[1] };
                    ws["B12"] = { t: 's', v: obtenerNombreDia(mNoc[2]) + " " + mNoc[2] };
                    ws["C11"] = { t: 's', v: "20:00" }; ws["C12"] = { t: 's', v: "08:00" };
                    const cn = mNoc[3];
                    ws["B13"] = { t: 's', v: limpiarTexto(cn.split(",")[0]) };
                    const vn1 = cn.match(/VIS\s+([\s\S]+?)(?=VTO|MAR)/i);
                    const vn2 = cn.match(/VTO\s+([\s\S]+?)(?=MAR|$)/i);
                    const vn3 = cn.match(/MAR\s+([\s\S]+?)(?=\.[\s\r\n]*$|\r?\n|$)/i);
                    if (vn1) ws["C14"] = { t: 's', v: limpiarTexto(vn1[1]) };
                    if (vn2) ws["E14"] = { t: 's', v: limpiarTexto(vn2[1]) };
                    if (vn3) ws["I14"] = { t: 's', v: limpiarTexto(vn3[1]) };
                    if (idHoja !== "melinka72" && cn.split(",").length >= 2) ws["B14"] = { t: 's', v: limpiarTexto(cn.split(",")[1]) };
                }

                // 7. DIAS FUTUROS
                const regexDias = /(LUNES|MARTES|MIERCOLES|JUEVES|VIERNES|SABADO|DOMINGO)\s+(\d{2})[\s.]*SITUACION SINOPTICA:\s*([\s\S]*?)\s*PRONOSTICO:\s*([\s\S]*?)(?=(?:LUNES|MARTES|MIERCOLES|JUEVES|VIERNES|SABADO|DOMINGO)\s+\d{2}|MET011|EMITIDO|$)/gi;
                let match, contador = 0;
                while ((match = regexDias.exec(texto)) !== null) {
                    contador++; if (contador > 2) break;
                    let fBase = (contador === 1) ? 16 : 22;
                    let fPron = (contador === 1) ? 18 : 24;

                    ws["B" + fBase] = { t: 's', v: match[1] };
                    ws["C" + fBase] = { t: 'n', v: parseInt(match[2]) };
                    ws["D" + fBase] = { t: 's', v: mesActual };
                    ws["B" + (fBase + 1)] = { t: 's', v: limpiarTexto(match[3]) };

                    const pf = match[4];
                    ws["B" + fPron] = { t: 's', v: limpiarTexto(pf.split(",")[0]) };
                    const vf1 = pf.match(/VIS\s+([\s\S]+?)(?=VTO|MAR)/i);
                    const vf2 = pf.match(/VTO\s+([\s\S]+?)(?=MAR|$)/i);
                    const vf3 = pf.match(/MAR\s+([\s\S]+?)(?=\.[\s\r\n]*$|\r?\n|$)/i);
                    if (vf1) ws["C" + fPron] = { t: 's', v: limpiarTexto(vf1[1]) };
                    if (vf2) ws["E" + fPron] = { t: 's', v: limpiarTexto(vf2[1]) };
                    if (vf3) ws["I" + fPron] = { t: 's', v: limpiarTexto(vf3[1]) };

                    const tMinF = pf.match(/MINIMA\s*PROBABLE\s*[:\-]?\s*(\d+\s*°C)/i);
                    const tMaxF = pf.match(/MAXIMA\s*PROBABLE\s*[:\-]?\s*(\d+\s*°C)/i);
                    if (tMinF) ws["B" + (fBase + 3)] = { t: 's', v: tMinF[1] };
                    if (tMaxF) ws["B" + (fBase + 4)] = { t: 's', v: tMaxF[1] };
                }
            });

            XLSX.writeFile(wb, "10.- CenMeteoPUERTOMONTT.xlsx");
            alert("✅ Archivo generado con éxito. Las celdas duplicadas han sido eliminadas.");
        };
        reader.readAsArrayBuffer(fileInput.files[0]);
    }
</script>
</body>
</html>
