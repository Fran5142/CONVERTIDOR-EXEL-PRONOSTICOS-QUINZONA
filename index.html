<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Meteo Puerto Montt - Melinka Selectivo</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --navy: #0a192f; --cyan: #64ffda; --white: #e6f1ff; --card: #112240; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--navy); color: var(--white); padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        h1 { text-align: center; color: var(--cyan); text-transform: uppercase; letter-spacing: 2px; }
        .file-section { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--cyan); text-align: center; }
        .grid-zonas { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; }
        .zona-card { background: var(--card); padding: 15px; border-radius: 10px; border-top: 4px solid var(--cyan); }
        textarea { width: 100%; height: 200px; background: #0a192f; border: 1px solid #233554; color: white; border-radius: 5px; padding: 10px; box-sizing: border-box; resize: none; font-size: 0.85rem; }
        .btn-grande { background: var(--cyan); color: var(--navy); border: none; padding: 20px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 1.2rem; cursor: pointer; margin-top: 25px; transition: 0.3s; }
        .btn-grande:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(100, 255, 218, 0.4); }
    </style>
</head>
<body>

<div class="container">
    <h1>üöÄ Sistema Meteo Puerto Montt PRO</h1>
    
    <div class="file-section">
        <label><b>1. SELECCIONA EL EXCEL ORIGINAL:</b></label><br><br>
        <input type="file" id="inputExcel" accept=".xlsx">
    </div>

    <div class="grid-zonas">
        <div class="zona-card"><h3>MAULL√çN</h3><textarea id="txt_maullin72"></textarea></div>
        <div class="zona-card"><h3>CHACAO</h3><textarea id="txt_chacao72"></textarea></div>
        <div class="zona-card"><h3>PUERTO MONTT</h3><textarea id="txt_pmontt72"></textarea></div>
        <div class="zona-card"><h3>BOCA DEL GUAFO</h3><textarea id="txt_guafo72"></textarea></div>
        <div class="zona-card"><h3>CHACABUCO</h3><textarea id="txt_chacabuco72"></textarea></div>
        <div class="zona-card"><h3>GOLFO DE PENAS</h3><textarea id="txt_golfopenas72"></textarea></div>
        <div class="zona-card"><h3>MELINKA</h3><textarea id="txt_melinka72"></textarea></div>
    </div>

    <button class="btn-grande" onclick="procesarTodo()">GENERAR EXCEL (MELINKA OPTIMIZADO)</button>
</div>

<script>
    const meses = ["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];

    function limpiarTextoMeteo(t) {
        if (!t) return "";
        let limpio = t.trim();
        limpio = limpio.replace(/,$/, ""); 
        if (limpio.endsWith(".") && !/\d$/.test(limpio.slice(-2, -1))) {
            limpio = limpio.slice(0, -1);
        }
        return limpio.trim().replace(/\s+/g, " ");
    }

    function obtenerNombreDia(diaNumStr) {
        const diasSemana = ["DOMINGO", "LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO"];
        const num = parseInt(diaNumStr);
        const hoy = new Date();
        let fecha = new Date(hoy.getFullYear(), hoy.getMonth(), num);
        if (num < hoy.getDate() - 10) fecha = new Date(hoy.getFullYear(), hoy.getMonth() + 1, num);
        return diasSemana[fecha.getDay()];
    }

    function procesarTodo() {
        const fileInput = document.getElementById("inputExcel");
        if (fileInput.files.length === 0) { alert("Sube el Excel."); return; }

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            const idsHojas = ["maullin72", "chacao72", "pmontt72", "guafo72", "chacabuco72", "golfopenas72", "melinka72"];
            const mesActual = meses[new Date().getMonth()];

            idsHojas.forEach(idHoja => {
                const texto = document.getElementById("txt_" + idHoja).value.trim();
                const ws = wb.Sheets[idHoja];
                if (!ws || texto === "") return;

                // --- 1. CABECERA ---
                const matchCab = texto.match(/VALIDO DESDE\s*(\d{2})\d{4}/i);
                if (matchCab) {
                    ws["B2"] = { t: 's', v: obtenerNombreDia(matchCab[1]) };
                    ws["B3"] = { t: 'n', v: parseInt(matchCab[1]) };
                    ws["B4"] = { t: 's', v: mesActual };
                }

                // --- 2. SITUACI√ìN D√çA 1 ---
                const sit1 = texto.match(/SITUACION SINOPTICA:\s*([\s\S]*?)(?=PRONOSTICO|VIS)/i);
                ws["B5"] = sit1 ? { t: 's', v: limpiarTextoMeteo(sit1[1]) } : { t: 's', v: "" };

                // --- 3. PRON√ìSTICO D√çA 1 (Fila 7) ---
                const pronostico1 = texto.match(/PRONOSTICO:\s*([\s\S]*?)(?=TEMPERATURA|PRONOSTICO VALIDO|EMITIDO|$)/i);
                if (pronostico1) {
                    const p1 = pronostico1[1];
                    const partesP1 = p1.split(",");
                    ws["B7"] = { t: 's', v: limpiarTextoMeteo(partesP1[0]) };
                    
                    const vis1 = p1.match(/VIS\s+([\s\S]+?)(?=VTO|MAR)/i);
                    const vto1 = p1.match(/VTO\s+([\s\S]+?)(?=MAR|$)/i);
                    const mar1 = p1.match(/MAR\s+([\s\S]+?)(?=\.[\s\r\n]*$|\r?\n|TEMPERATURA|EMITIDO|$)/i);
                    
                    ws["C7"] = vis1 ? { t: 's', v: limpiarTextoMeteo(vis1[1]) } : { t: 's', v: "" };
                    ws["E7"] = vto1 ? { t: 's', v: limpiarTextoMeteo(vto1[1]) } : { t: 's', v: "" };
                    ws["I7"] = mar1 ? { t: 's', v: limpiarTextoMeteo(mar1[1]) } : { t: 's', v: "" };
                }
                ws["J7"] = { t: 's', v: " " }; ws["K7"] = { t: 's', v: " " };

                // --- 4. TEMPERATURAS / UV (Solo si existen) ---
                const tMin1 = texto.match(/MINIMA\s*PROBABLE\s*[:\-]?\s*(\d+\s*¬∞C)/i);
                const tMax1 = texto.match(/MAXIMA\s*PROBABLE\s*[:\-]?\s*(\d+\s*¬∞C)/i);
                ws["B8"] = tMin1 ? { t: 's', v: tMin1[1] } : { t: 's', v: "" };
                ws["B9"] = tMax1 ? { t: 's', v: tMax1[1] } : { t: 's', v: "" };

                const uv = texto.match(/INDICE DE RADIACION\s*([\s\S]*?\(FUENTE DMC\)\.?)/i);
                ws["B10"] = uv ? { t: 's', v: limpiarTextoMeteo(uv[1]) } : { t: 's', v: "" };

                // --- 5. NOCTURNO (Fila 14) ---
                const matchNoc = texto.match(/PRONOSTICO VALIDO DESDE\s*(\d{2})\d{4}\s*HASTA\s*(\d{2})\d{4}\s*HORA LOCAL\.\s*([\s\S]*?)(?=(?:LUNES|MARTES|MIERCOLES|JUEVES|VIERNES|SABADO|DOMINGO)\s*\d{2}|MET011|EMITIDO|$)/i);
                if (matchNoc) {
                    const cuerpoNoc = matchNoc[3];
                    const partesN = cuerpoNoc.split(",");
                    ws["B13"] = { t: 's', v: limpiarTextoMeteo(partesN[0]) };
                    ws["B14"] = { t: 's', v: partesN[1] ? limpiarTextoMeteo(partesN[1]) : "" };
                    
                    const visN = cuerpoNoc.match(/VIS\s+([\s\S]+?)(?=VTO|MAR)/i);
                    const vtoN = cuerpoNoc.match(/VTO\s+([\s\S]+?)(?=MAR|$)/i);
                    const marN = cuerpoNoc.match(/MAR\s+([\s\S]+?)(?=\.[\s\r\n]*$|\r?\n|$)/i);
                    
                    ws["C14"] = visN ? { t: 's', v: limpiarTextoMeteo(visN[1]) } : { t: 's', v: "" };
                    ws["E14"] = vtoN ? { t: 's', v: limpiarTextoMeteo(vtoN[1]) } : { t: 's', v: "" };
                    ws["I14"] = marN ? { t: 's', v: limpiarTextoMeteo(marN[1]) } : { t: 's', v: "" };
                    ws["J14"] = { t: 's', v: " " }; ws["K14"] = { t: 's', v: " " };
                } else {
                    // Si no hay nocturno, limpiar filas 11 a 14
                    ["B11","B12","C11","C12","B13","B14","C14","E14","I14","J14","K14"].forEach(c => ws[c] = {t:'s', v:""});
                }

                // --- 6. D√çAS FUTUROS (16 y 22) ---
                const regexDias = /(LUNES|MARTES|MIERCOLES|JUEVES|VIERNES|SABADO|DOMINGO)\s*(\d{2})\.\s*SITUACION SINOPTICA:\s*([\s\S]*?)\s*PRONOSTICO:\s*([\s\S]*?)(?=\s*(?:MINIMA|LUNES|MARTES|MIERCOLES|JUEVES|VIERNES|SABADO|DOMINGO)|MET011|EMITIDO|$)/gi;
                let matchDia;
                let contadorDia = 0;
                while ((matchDia = regexDias.exec(texto)) !== null) {
                    contadorDia++;
                    if (contadorDia > 2) break;
                    let fBase = (contadorDia === 1) ? 16 : 22;
                    let fPron = (fBase + 2); // 18 o 24
                    
                    ws["B" + fBase] = { t: 's', v: matchDia[1] };
                    ws["C" + fBase] = { t: 'n', v: parseInt(matchDia[2]) };
                    ws["D" + fBase] = { t: 's', v: mesActual }; 
                    ws["B" + (fBase + 1)] = { t: 's', v: limpiarTextoMeteo(matchDia[3]) };

                    const cuerpo = matchDia[4];
                    const partesF = cuerpo.split(",");
                    ws["B" + fPron] = { t: 's', v: limpiarTextoMeteo(partesF[0]) };
                    
                    const visF = cuerpo.match(/VIS\s+([\s\S]+?)(?=VTO|MAR)/i);
                    const vtoF = cuerpo.match(/VTO\s+([\s\S]+?)(?=MAR|$)/i);
                    const marF = cuerpo.match(/MAR\s+([\s\S]+?)(?=\.[\s\r\n]*$|\r?\n|$)/i);
                    
                    ws["C" + fPron] = visF ? { t: 's', v: limpiarTextoMeteo(visF[1]) } : { t: 's', v: "" };
                    ws["E" + fPron] = vtoF ? { t: 's', v: limpiarTextoMeteo(vtoF[1]) } : { t: 's', v: "" };
                    ws["I" + fPron] = marF ? { t: 's', v: limpiarTextoMeteo(marF[1]) } : { t: 's', v: "" };
                    ws["J" + fPron] = { t: 's', v: " " }; ws["K" + fPron] = { t: 's', v: " " };

                    // Temperaturas Futuras (Solo si existen cerca del d√≠a)
                    const bloqueFut = texto.substring(matchDia.index, matchDia.index + 700);
                    const tMinF = bloqueFut.match(/MINIMA\s*PROBABLE\s*[:\-]?\s*(\d+\s*¬∞C)/i);
                    const tMaxF = bloqueFut.match(/MAXIMA\s*PROBABLE\s*[:\-]?\s*(\d+\s*¬∞C)/i);
                    ws["B" + (fBase + 3)] = tMinF ? { t: 's', v: tMinF[1] } : { t: 's', v: "" };
                    ws["B" + (fBase + 4)] = tMaxF ? { t: 's', v: tMaxF[1] } : { t: 's', v: "" };
                }
            });

            XLSX.writeFile(wb, "Meteo_Melinka_Limpio.xlsx");
            alert("‚úÖ ¬°Archivo generado! Se han respetado las celdas vac√≠as en Melinka.");
        };
        reader.readAsArrayBuffer(fileInput.files[0]);
    }
</script>
</body>
</html>
