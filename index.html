<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Meteo Puerto Montt - Melinka Preciso</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --navy: #0a192f; --cyan: #64ffda; --white: #e6f1ff; --card: #112240; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--navy); color: var(--white); padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        h1 { text-align: center; color: var(--cyan); text-transform: uppercase; letter-spacing: 2px; }
        .file-section { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--cyan); text-align: center; }
        .grid-zonas { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; }
        .zona-card { background: var(--card); padding: 15px; border-radius: 10px; border-top: 4px solid var(--cyan); }
        textarea { width: 100%; height: 200px; background: #0a192f; border: 1px solid #233554; color: white; border-radius: 5px; padding: 10px; box-sizing: border-box; resize: none; font-size: 0.85rem; }
        .btn-grande { background: var(--cyan); color: var(--navy); border: none; padding: 20px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 1.2rem; cursor: pointer; margin-top: 25px; transition: 0.3s; }
        .btn-grande:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(100, 255, 218, 0.4); }
    </style>
</head>
<body>

<div class="container">
    <h1>üöÄ Meteo Puerto Montt - Melinka Pro</h1>
    
    <div class="file-section">
        <label><b>1. SELECCIONA EL EXCEL ORIGINAL:</b></label><br><br>
        <input type="file" id="inputExcel" accept=".xlsx">
    </div>

    <div class="grid-zonas">
        <div class="zona-card"><h3>MAULL√çN</h3><textarea id="txt_maullin72"></textarea></div>
        <div class="zona-card"><h3>CHACAO</h3><textarea id="txt_chacao72"></textarea></div>
        <div class="zona-card"><h3>PUERTO MONTT</h3><textarea id="txt_pmontt72"></textarea></div>
        <div class="zona-card"><h3>BOCA DEL GUAFO</h3><textarea id="txt_guafo72"></textarea></div>
        <div class="zona-card"><h3>CHACABUCO</h3><textarea id="txt_chacabuco72"></textarea></div>
        <div class="zona-card"><h3>GOLFO DE PENAS</h3><textarea id="txt_golfopenas72"></textarea></div>
        <div class="zona-card"><h3>MELINKA</h3><textarea id="txt_melinka72"></textarea></div>
    </div>

    <button class="btn-grande" onclick="procesarTodo()">GENERAR EXCEL CORREGIDO</button>
</div>

<script>
    const meses = ["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];

    function limpiarTexto(t) {
        if (!t) return "";
        let limpio = t.trim().replace(/,$/, "");
        if (limpio.endsWith(".") && !/\d$/.test(limpio.slice(-2, -1))) {
            limpio = limpio.slice(0, -1);
        }
        return limpio.trim().replace(/\s+/g, " ");
    }

    function procesarTodo() {
        const fileInput = document.getElementById("inputExcel");
        if (fileInput.files.length === 0) { alert("Sube el Excel."); return; }

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            const idsHojas = ["maullin72", "chacao72", "pmontt72", "guafo72", "chacabuco72", "golfopenas72", "melinka72"];
            const mesActual = meses[new Date().getMonth()];

            idsHojas.forEach(idHoja => {
                const texto = document.getElementById("txt_" + idHoja).value.trim();
                const ws = wb.Sheets[idHoja];
                if (!ws || texto === "") return;

                // --- 1. FECHAS ---
                const matchCab = texto.match(/VALIDO DESDE\s*(\d{2})/i);
                if (matchCab) {
                    ws["B3"] = { t: 'n', v: parseInt(matchCab[1]) };
                    ws["B4"] = { t: 's', v: mesActual };
                }

                // --- 2. SITUACION SINOPTICA ---
                const sit1 = texto.match(/SITUACION SINOPTICA:\s*([\s\S]*?)(?=PRONOSTICO)/i);
                if (sit1) ws["B5"] = { t: 's', v: limpiarTexto(sit1[1]) };

                // --- 3. PRONOSTICO DIA (B7, C7, E7, I7) ---
                const bloqueP1 = texto.match(/PRONOSTICO:\s*([\s\S]*?)(?=PRONOSTICO VALIDO|MET011|EMITIDO|$)/i);
                if (bloqueP1) {
                    const p1 = bloqueP1[1];
                    // Cielo (B7)
                    const cielo = p1.match(/^([\s\S]*?),\s*VIS/i);
                    if (cielo) ws["B7"] = { t: 's', v: limpiarTexto(cielo[1]) };
                    
                    // Visibilidad (C7) - Captura VIS + Texto hasta VTO
                    const vis = p1.match(/VIS\s+([\s\S]*?)(?=VTO)/i);
                    if (vis) ws["C7"] = { t: 's', v: limpiarTexto(vis[1]) };

                    // Viento (E7) - Captura VTO + Texto hasta MAR
                    const vto = p1.match(/VTO\s+([\s\S]*?)(?=MAR)/i);
                    if (vto) ws["E7"] = { t: 's', v: limpiarTexto(vto[1]) };

                    // MAR (I7) - Todo lo que sigue despu√©s de MAR
                    const mar = p1.match(/MAR\s+([\s\S]*?)(?=\.[\s\r\n]*$|\r?\n|EMITIDO|$)/i);
                    if (mar) ws["I7"] = { t: 's', v: limpiarTexto(mar[1]) };
                }

                // --- 4. PRONOSTICO NOCTURNO (B13, E14) ---
                const bloqueP2 = texto.match(/PRONOSTICO VALIDO DESDE \d{6} HASTA \d{6} HORA LOCAL\.\s*([\s\S]*?)(?=LUNES|MARTES|MIERCOLES|JUEVES|VIERNES|SABADO|DOMINGO|MET011|EMITIDO|$)/i);
                
                // Primero limpiamos el bloque nocturno por si acaso
                ["B13", "B14", "C14", "E14", "I14"].forEach(c => ws[c] = {t:'s', v:""});

                if (bloqueP2) {
                    const p2 = bloqueP2[1].trim();
                    // B13: Primera frase antes de la coma (SITUACION)
                    const situNoc = p2.match(/^([\s\S]*?),\s*VTO/i);
                    if (situNoc) {
                        ws["B13"] = { t: 's', v: limpiarTexto(situNoc[1]) };
                    } else {
                        // Si no hay coma/vto, tomamos la primera l√≠nea como situacion
                        ws["B13"] = { t: 's', v: limpiarTexto(p2.split(",")[0]) };
                    }

                    // E14: Viento (VTO en adelante)
                    const vtoNoc = p2.match(/VTO\s+([\s\S]*?)(?=\.[\s\r\n]*$|\r?\n|$)/i);
                    if (vtoNoc) ws["E14"] = { t: 's', v: limpiarTexto(vtoNoc[1]) };
                }

                // J y K ficticios
                ws["J7"] = { t: 's', v: " " }; ws["K7"] = { t: 's', v: " " };
                ws["J14"] = { t: 's', v: " " }; ws["K14"] = { t: 's', v: " " };
                
                // Limpiar Temperaturas si no existen
                if (!texto.includes("MINIMA")) {
                    ws["B8"] = { t: 's', v: "" }; ws["B19"] = { t: 's', v: "" }; ws["B25"] = { t: 's', v: "" };
                }
                if (!texto.includes("MAXIMA")) {
                    ws["B9"] = { t: 's', v: "" }; ws["B20"] = { t: 's', v: "" }; ws["B26"] = { t: 's', v: "" };
                }
            });

            XLSX.writeFile(wb, "Meteo_Melinka_Ruta.xlsx");
            alert("‚úÖ ¬°Excel generado! Datos de Melinka distribuidos correctamente.");
        };
        reader.readAsArrayBuffer(fileInput.files[0]);
    }
</script>
</body>
</html>
