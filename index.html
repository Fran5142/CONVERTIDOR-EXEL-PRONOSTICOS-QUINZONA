<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Meteo Puerto Montt - Sin Temperaturas Forzadas</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --navy:#0a192f; --cyan:#64ffda; --white:#e6f1ff; --card:#112240; }
        body { font-family:'Segoe UI',sans-serif; background:var(--navy); color:var(--white); padding:20px; }
        .container { max-width:1200px; margin:auto; }
        h1 { text-align:center; color:var(--cyan); text-transform:uppercase; letter-spacing:2px; }
        .file-section { background:var(--card); padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid var(--cyan); text-align:center; }
        .grid-zonas { display:grid; grid-template-columns:repeat(auto-fit,minmax(350px,1fr)); gap:15px; }
        .zona-card { background:var(--card); padding:15px; border-radius:10px; border-top:4px solid var(--cyan); }
        textarea { width:100%; height:200px; background:#0a192f; border:1px solid #233554; color:white; border-radius:5px; padding:10px; resize:none; font-size:0.85rem; }
        .btn-grande { background:var(--cyan); color:var(--navy); border:none; padding:20px; width:100%; border-radius:12px; font-weight:bold; font-size:1.2rem; cursor:pointer; margin-top:25px; transition:.3s; }
        .btn-grande:hover { transform:translateY(-3px); box-shadow:0 10px 20px rgba(100,255,218,.4); }
    </style>
</head>
<body>

<div class="container">
    <h1>üöÄ Sistema Meteo Puerto Montt PRO</h1>

    <div class="file-section">
        <label><b>1. SELECCIONA EL EXCEL ORIGINAL:</b></label><br><br>
        <input type="file" id="inputExcel" accept=".xlsx">
    </div>

    <div class="grid-zonas">
        <div class="zona-card"><h3>MAULL√çN</h3><textarea id="txt_maullin72"></textarea></div>
        <div class="zona-card"><h3>CHACAO</h3><textarea id="txt_chacao72"></textarea></div>
        <div class="zona-card"><h3>PUERTO MONTT</h3><textarea id="txt_pmontt72"></textarea></div>
        <div class="zona-card"><h3>BOCA DEL GUAFO</h3><textarea id="txt_guafo72"></textarea></div>
        <div class="zona-card"><h3>CHACABUCO</h3><textarea id="txt_chacabuco72"></textarea></div>
        <div class="zona-card"><h3>GOLFO DE PENAS</h3><textarea id="txt_golfopenas72"></textarea></div>
        <div class="zona-card"><h3>MELINKA</h3><textarea id="txt_melinka72"></textarea></div>
    </div>

    <button class="btn-grande" onclick="procesarTodo()">GENERAR EXCEL VALIDADO</button>
</div>

<script>
const meses = ["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];

function limpiarTexto(t){
    if(!t) return "";
    let l=t.trim().replace(/,$/,"");
    if(l.endsWith(".") && !/\d$/.test(l.slice(0,-1))) l=l.slice(0,-1);
    return l.replace(/\s+/g," ");
}

function obtenerNombreDia(d){
    const dias=["DOMINGO","LUNES","MARTES","MIERCOLES","JUEVES","VIERNES","SABADO"];
    const hoy=new Date();
    let f=new Date(hoy.getFullYear(),hoy.getMonth(),parseInt(d));
    if(parseInt(d)<hoy.getDate()-10) f=new Date(hoy.getFullYear(),hoy.getMonth()+1,parseInt(d));
    return dias[f.getDay()];
}

function espacios(ws,fila){
    ws["J"+fila]={t:'s',v:"  "};
    ws["K"+fila]={t:'s',v:"  "};
}

function procesarTodo(){
    const fi=document.getElementById("inputExcel");
    if(fi.files.length===0){ alert("Sube el Excel."); return; }

    const reader=new FileReader();
    reader.onload=e=>{
        const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
        const hojas=["maullin72","chacao72","pmontt72","guafo72","chacabuco72","golfopenas72","melinka72"];
        const mesActual=meses[new Date().getMonth()];

        hojas.forEach(id=>{
            const texto=document.getElementById("txt_"+id).value.trim();
            if(!texto) return;
            const ws=wb.Sheets[id];
            if(!ws) return;

            const cab=texto.match(/VALIDO DESDE\s*(\d{2})\d{4}/i);
            if(cab){
                ws["B2"]={t:'s',v:obtenerNombreDia(cab[1])};
                ws["B3"]={t:'n',v:parseInt(cab[1])};
                ws["B4"]={t:'s',v:mesActual};
            }

            const sit=texto.match(/SITUACION SINOPTICA:\s*([\s\S]*?)(?=PRONOSTICO|VIS)/i);
            if(sit) ws["B5"]={t:'s',v:limpiarTexto(sit[1])};

            const pro=texto.match(/PRONOSTICO:\s*([\s\S]*?)(?=TEMPERATURA|PRONOSTICO VALIDO|EMITIDO|$)/i);
            if(pro){
                const c=pro[1];
                ws["B7"]={t:'s',v:limpiarTexto(c.split(",")[0])};
                const vis=c.match(/VIS\s+(.+?)(?=VTO|MAR)/i);
                const vto=c.match(/VTO\s+(.+?)(?=MAR|$)/i);
                const mar=c.match(/MAR\s+(.+?)(?=\.|\n|$)/i);
                if(vis) ws["C7"]={t:'s',v:limpiarTexto(vis[1])};
                if(vto) ws["E7"]={t:'s',v:limpiarTexto(vto[1])};
                if(mar) ws["I7"]={t:'s',v:limpiarTexto(mar[1])};
            }
            espacios(ws,7);

            const noc=texto.match(/PRONOSTICO VALIDO DESDE\s*(\d{2})\d{4}\s*HASTA\s*(\d{2})\d{4}.*?([\s\S]*?)(?=LUNES|MARTES|MIERCOLES|JUEVES|VIERNES|SABADO|DOMINGO|MET011|EMITIDO|$)/i);
            if(noc){
                ws["B11"]={t:'s',v:obtenerNombreDia(noc[1])+" "+noc[1]};
                ws["B12"]={t:'s',v:obtenerNombreDia(noc[2])+" "+noc[2]};
                ws["C11"]={t:'s',v:"20:00"};
                ws["C12"]={t:'s',v:"08:00"};
                ws["B13"]={t:'s',v:limpiarTexto(noc[3].split(",")[0])};
                ws["B14"]={t:'s',v:limpiarTexto(noc[3].split(",")[1]||"")};
            }
            espacios(ws,14);

            espacios(ws,18);
            espacios(ws,24);
        });

        XLSX.writeFile(wb,"Meteo_PM_Validado.xlsx");
        alert("‚úÖ Excel generado con espacios ficticios aplicados.");
    };
    reader.readAsArrayBuffer(fi.files[0]);
}
</script>
</body>
</html>
